{"version":3,"file":"musicPlayer.js","sources":["pages/musicPlayer/musicPlayer.vue","../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbXVzaWNQbGF5ZXIvbXVzaWNQbGF5ZXIudnVl"],"sourcesContent":["<template>\r\n\t<view v-if=\"data.isShow\">\r\n\t\t<view class=\"musicPlayer\">\r\n\t\t\t<image class=\"backgroundImg\" :src=\"playerStore.songDetail.al.picUrl\" mode=\"aspectFill\"/>\r\n\t\t\t<view class=\"backgroundMask\"></view>\r\n\t\t\t<!-- navigation -->\r\n\t\t\t<uni-nav-bar \r\n\t\t\t\tbackground-color=\"transparent\" \r\n\t\t\t\tclass=\"navBar\"\r\n\t\t\t\t:border=\"false\" \r\n\t\t\t\tleft-icon=\"left\" \r\n\t\t\t\tcolor=\"#fff\" \r\n\t\t\t\t@clickLeft=\"backClick\"\r\n\t\t\t>\r\n\t\t\t\t<view class=\"center\">\r\n\t\t\t\t\t<view v-for=\"(item, index) in data.titleConfig\" :key=\"index\">\r\n\t\t\t\t\t\t<view class=\"text\">\r\n\t\t\t\t\t\t\t<text\r\n\t\t\t\t\t\t\t    :class=\"{'active': data.currentPage === index}\" \r\n\t\t\t\t\t\t\t    @click=\"data.currentPage = index\" \r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{{item}}\r\n\t\t\t\t\t\t\t</text>\r\n\t\t\t\t\t\t\t<text class=\"line\" v-if=\"index === 0\">|</text>\r\n\t\t\t\t\t\t</view>\t\t\t\t\t\t\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</uni-nav-bar>\r\n\t\t\t<!-- content -->\r\n\t\t\t<swiper @change=\"pageChange\" :style=\"`height: ${data.contentHeight}px;`\" :current=\"data.currentPage\">\r\n\t\t\t\t<swiper-item class=\"musicPage\">\r\n\t\t\t\t\t<view class=\"album\">\r\n\t\t\t\t\t\t<image class=\"albumImg\" :src=\"playerStore.songDetail.al.picUrl\" mode=\"widthFix\"/>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"info\">\r\n\t\t\t\t\t\t<view class=\"title\">{{playerStore.songDetail.name}}</view>\r\n\t\t\t\t\t\t<view class=\"artist\">{{playerStore.songDetail.ar[0].name}}</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"lyrics\">{{playerStore.currentLyrics}}</view>\r\n\t\t\t\t\t<slider class=\"slider\" \r\n\t\t\t\t\t\tblock-size=\"15\"\r\n\t\t\t\t\t\t:value=\"playerStore.sliderLength\"\r\n\t\t\t\t\t\t@change=\"sliderChange\"\r\n\t\t\t\t\t\t@changing=\"sliderChanging\"\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t/>\r\n\t\t\t\t\t<view class=\"songTime\">\r\n\t\t\t\t\t\t<view class=\"start\">{{formatPlayTime(playerStore.currentTime)}}</view>\r\n\t\t\t\t\t\t<view class=\"end\">{{formatPlayTime(playerStore.durationTime)}}</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"controls\">\r\n\t\t\t\t\t\t<image class=\"order\" :src=\"`/static/play_${playerStore.currentOrderName}.png`\" @click=\"orderChange\"/>\r\n\t\t\t\t\t\t<image class=\"prev\" src=\"/static/play_prev.png\" @click=\"prevClick\"/>\r\n\t\t\t\t\t\t<image \r\n\t\t\t\t\t\t\tclass=\"pause\"\r\n\t\t\t\t\t\t\t:src=\"`/static/play_${playerStore.isPlaying ? 'pause' : 'resume'}.png`\"\r\n\t\t\t\t\t\t\t@click=\"playClick\"\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t<image class=\"next\" src=\"/static/play_next.png\" @click=\"nextClick\"/>\r\n\t\t\t\t\t\t<image class=\"list\" src=\"/static/play_music.png\" />\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</swiper-item>\r\n\t\t\t\t<swiper-item class=\"musicLyrics\">\r\n\t\t\t\t\t<scroll-view class=\"lyrics\" scroll-y  :scroll-top=\"playerStore.scrollToTop\" scroll-with-animation show-scrollbar=false>\r\n\t\t\t\t\t\t<view v-for=\"(item, index) in playerStore.lyricsList\" :key=\"index\">\r\n\t\t\t\t\t\t\t<view\r\n\t\t\t\t\t\t\t\t:class=\"`lyricItem ${index === playerStore.currentIndex ? 'active' : ''}`\"\r\n\t\t\t\t\t\t\t\t:style=\"`margin-top: ${index === 0 ? data.contentHeight-40 : 0}rpx; \r\n\t\t\t\t\t\t\t\tpadding-bottom: ${index === playerStore.lyricsList.length - 1 ? data.contentHeight+40 : 0}rpx;`\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{{item.text}}\r\n\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</scroll-view>\r\n\t\t\t\t</swiper-item>\r\n\t\t\t</swiper>\r\n\t\t</view>\r\n\t</view>\n</template>\n\n<script setup>\nimport { reactive } from 'vue';\r\nimport { onLoad, onUnload } from '@dcloudio/uni-app'\nimport { fetchSongProxyUrl } from '../../service/module/plyaer';\nimport usePlayer from '../../store/module/player';\nimport { formatPlayTime } from '@/utils/formatView.js'\r\nimport { throttle } from '../../utils/throttle';\r\nimport { audioInstance } from '../../utils/audioInstance';\nconst audioContext = audioInstance()\nconst data = reactive({\n\tid: 0,\n\ttitleConfig: [\"歌曲\", \"歌词\"],\r\n\tcontentHeight: 100,\r\n\tcurrentPage: 0,\r\n\tisShow: false,\r\n})\t\r\nconst playerStore = usePlayer()\r\nlet timer = null\r\nonLoad(async (options) => {\r\n\tif(playerStore.isFirstPlay) {\r\n\t\tplayerStore.isFirstPlay = false\r\n\t\taudioContext.onEnded(nextClick)\r\n\t}\r\n\tconsole.log('playMusicOnLoad');\r\n\tconst id = options.id\r\n\t// 获取屏幕高度\r\n\tconst systemInfo = uni.getSystemInfoSync();\r\n\tconst contentHeight = systemInfo.windowHeight;\r\n\tdata.contentHeight = contentHeight - 44\r\n\t// 获取歌曲\r\n\tif(id) {\r\n\t\tgetSong(id)\r\n\t} else {\r\n\t\tdata.isShow = true\r\n\t}\r\n\ttimer = setInterval(audioUpdate, 100)\r\n})\r\n// 播放暂停切换\nconst playClick = () => {\n    if(playerStore.isPlaying) {\n      audioContext.pause()\r\n\t  playerStore.isPlaying = false\n    } else {\n      audioContext.play()\r\n\t  playerStore.isPlaying = true\n    }\n  }\r\n// 下一首\r\nconst nextClick = () => {\r\n\tindexChange()\r\n}\r\n// 上一首\nconst prevClick = () => {\r\n\tindexChange(false)\n}\r\n//歌曲跳转\r\nconst indexChange = (next = true) => {\r\n\tlet songIndex = playerStore.songIndex\r\n\tconst length = playerStore.songList.length\r\n\tswitch(playerStore.currentOrder) {\r\n\t\tcase 0:\r\n\t\t  songIndex = next ?  songIndex + 1 : songIndex - 1\r\n\t\t  songIndex = (songIndex + length) % length\r\n\t\t  break;\r\n\t\tcase 1:\r\n\t\t  break;\r\n\t\tcase 2:\r\n\t\t  songIndex = Math.floor(Math.random() * length)\r\n\t\t  break;\r\n  }\r\n  playerStore.songIndex = songIndex\r\n  const currentId = playerStore.songList[songIndex].id\r\n  getSong(currentId)\r\n}\r\n// 切换模式\nconst orderChange = () => {\r\n\tconst orderName = [\"order\", \"repeat\", \"random\"]\n\tlet currentOrder = playerStore.currentOrder\n\tcurrentOrder = (currentOrder + 1) % 3\r\n\tplayerStore.currentOrder = currentOrder\r\n\tplayerStore.currentOrderName = orderName[currentOrder]\n}\r\n//获取歌曲&播放\r\nconst getSong = async(id) => {\r\n\tconst proxyRes = await fetchSongProxyUrl(id)\r\n\ttry {\r\n\t\tconsole.log(proxyRes);\r\n\t\tif(proxyRes.data.code !== 200) {\r\n\t\t\tthrow new Error(`HTTP error! status`);\r\n\t\t\treturn\r\n\t\t} \r\n\t\tconst proxyUrl = proxyRes.data.data.url\r\n\t\taudioContext.src = proxyUrl\r\n\t} catch(error) {\r\n\t\tconsole.log('报错',error);\r\n\t\tconsole.log('启动非代理url');\r\n\t\taudioContext.src = `https://music.163.com/song/media/outer/url?id=${id}.mp3`\r\n\t}\r\n\tawait playerStore.getSongs(id)\r\n\tdata.isShow = true\r\n\taudioContext.stop()\r\n\taudioContext.autoplay = true\r\n\taudioContext.play()\r\n\t\r\n}\r\n\r\nconst audioUpdate = () => {\r\n\tif(playerStore.isSlide) return\r\n\t// console.log('throttle');\r\n\tconst currentTime = audioContext.currentTime * 1000\r\n\tplayerStore.currentTime = currentTime\r\n\tconst sliderLength = playerStore.currentTime / playerStore.durationTime * 100\r\n\tplayerStore.sliderLength = sliderLength\r\n\t// 切换歌词\r\n\tconst lyricsList = playerStore.lyricsList\r\n\tlet index = lyricsList.length - 1\r\n\tfor(let i = 0; i < lyricsList.length; i++) {\r\n\t\tif(lyricsList[i].time > audioContext.currentTime * 1000) {\r\n\t\t  index = i - 1\r\n\t\t  break\r\n\t\t}\r\n\t}\r\n\tif(playerStore.currentIndex === index) return \r\n\tplayerStore.currentIndex = index\r\n\tif(lyricsList[index]) {\r\n\t\tconst currentLyrics = lyricsList[index].text ?? ''\r\n\t\tplayerStore.currentLyrics = currentLyrics\r\n\t\tplayerStore.scrollToTop = 40 * index\r\n\t}\r\n}\r\n\r\n// 返回\r\nconst backClick = () => {\r\n\tuni.navigateBack()\r\n}\r\n// 歌曲进度条切换\nconst sliderChange = (event) => {\r\n\tconst currentNewTime = event.detail.value / 100 * playerStore.durationTime\r\n\taudioContext.seek(currentNewTime / 1000)\r\n\tplayerStore.currentTime = currentNewTime\r\n\tplayerStore.isSlide = false\r\n}\r\n//  滑动进度条\nconst sliderChanging = (event) => {\n\tplayerStore.isSlide = true\n// const currentNewTime = event.detail.value / 100 * this.data.durationTime\n// this.setData({currentTime: currentNewTime})\n}\r\n// 监听页面切换\nconst pageChange = (event) => {\r\n\tdata.currentPage = event.detail.current\n}\r\nonUnload(() => {\r\n\t// audioContext.destroy()\r\n\tclearInterval(timer)\r\n})\r\n\r\n// 保持屏幕常亮\nuni.setKeepScreenOn({\n\tkeepScreenOn: true,\r\n\tsuccess: () => {\r\n\t\tconsole.log('保持常亮');\r\n\t}\n})\r\n\r\n</script>\n\n<style lang=\"scss\">\r\n.musicPlayer {\r\n\theight: 100vh;\r\n\toverflow: hidden;\r\n\t.backgroundImg,\r\n\t.backgroundMask {\r\n\t\tposition: fixed;\r\n\t\tleft: 0;\r\n\t\ttop: 0;\r\n\t\tz-index: -1;\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tbackdrop-filter: blur(10px);\r\n\t\tbackground-color: rgba(0,0,0,.3);\r\n\t}\r\n\t.navBar {\r\n\t\tmargin-top: 44rpx;\r\n\t}\r\n\t.center {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\tcolor: #aaa;\r\n\t\tmargin: auto;\r\n\t\t.text {\r\n\t\t\tdisplay: flex;\r\n\t\t\tflex-direction: row;\r\n\t\t\tfont-size: 35rpx;\r\n\t\t\t.line{\r\n\t\t\t\tmargin: 0 8rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t\t.active {\r\n\t\t\tcolor: #fff;\r\n\t\t}\r\n\t}\r\n\t.musicPage {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tbox-sizing: border-box;\r\n\t\tpadding: 20rpx 60rpx;\r\n\t\tcolor: #fff;\r\n\t\t.album {\r\n\t\t\twidth: 100%;\r\n\t\t\tflex: 1;\r\n\t\t\t.albumImg {\r\n\t\t\t\twidth: 100%;\r\n\t\t\t\tborder-radius: 10rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t\t.info {\r\n\t\t\tmargin-bottom: 40rpx;\r\n\t\t\t.title {\r\n\t\t\t\tfont-size: 50rpx;\r\n\t\t\t\tfont-weight: 700;\r\n\t\t\t\tmargin-bottom: 10rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t\t.lyrics {\r\n\t\t\twidth: 85%;\r\n\t\t\theight: 100rpx;\r\n\t\t\tmargin: auto;  \r\n\t\t\ttext-align: center;\r\n\t\t\toverflow: hidden;\r\n\t\t\ttext-overflow: ellipsis;\r\n\t\t\twhite-space: nowrap;\r\n\t\t}\r\n\t\t.slider {\r\n\t\t\tmargin: 30rpx 0 20rpx 10rpx;\r\n\t\t}\r\n\t}\r\n\t.songTime {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\tjustify-content: space-between;\r\n\t\tfont-size: 25rpx;\r\n\t}\r\n\t.controls {\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: row;\r\n\t\tmargin: 40rpx 0;\r\n\t\tjustify-content: space-between;\r\n\t\talign-items: center;\r\n\t\t.order {\r\n\t\t\twidth: 100rpx;\r\n\t\t\theight: 100rpx;\r\n\t\t}\r\n\t\t.list,\r\n\t\t.prev,\r\n\t\t.next {\r\n\t\t\twidth: 70rpx;\r\n\t\t\theight: 70rpx;\r\n\t\t}\r\n\t\t.pause {\r\n\t\t\twidth: 120rpx;\r\n\t\t\theight: 120rpx;\r\n\t\t}\r\n\t}\r\n\t.lyrics {\r\n\t\theight: 100%;\r\n\t\t::-webkit-scrollbar {\r\n\t\t\tdisplay: none;\r\n\t\t}\r\n\t\t.lyricItem {\r\n\t\t\twidth: 85%;\r\n\t\t\tmargin: auto;\r\n\t\t\ttext-align: center;\r\n\t\t\tcolor: #aaa;\r\n\t\t\tfont-size: 30rpx;\r\n\t\t\theight: 80rpx;\r\n\t\t\tline-height: 40px;\r\n\t\t\toverflow: hidden;\r\n\t\t\ttext-overflow: ellipsis;\r\n\t\t\twhite-space: nowrap;\r\n\t\t\t&.active {\r\n\t\t\t\tcolor: aquamarine;\r\n\t\t\t\tfont-size: 40rpx;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\n</style>\n","import MiniProgramPage from 'D:/uniApp学习/YULEMusic/pages/musicPlayer/musicPlayer.vue'\nwx.createPage(MiniProgramPage)"],"names":["audioInstance","reactive","usePlayer","onLoad","uni","fetchSongProxyUrl","onUnload","MiniProgramPage"],"mappings":"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"}